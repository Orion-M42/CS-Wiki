---
permalink: /pages/capandbase/
---
## CAP 原理

<img src="https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/20201122170231.png" style="zoom:50%;" />

在理论计算机科学中，`CAP定理（CAP theorem）`，又被称作 `布鲁尔定理（Brewer’s theorem）`，它指出**对于一个分布式计算系统来说，不可能同时满足以下三点**：

- **一致性（Consistence）**

  一致性指的是多个数据副本是否能保持一致的特性，在一致性的条件下，系统在执行数据更新操作之后能够从一致性状态转移到另一个一致性状态。

  `<u>`对系统的一个数据更新成功之后，如果所有用户都能够读取到最新的值，该系统就被认为具有强一致性。`</u>`
- **可用性（Availability）**

  `<u>`可用性指分布式系统在面对各种异常时可以提供正常服务的能力`</u>`，可以用系统可用时间占总时间的比值来衡量，4 个 9 的可用性表示系统 99.99% 的时间是可用的。

  在可用性条件下，要求系统提供的服务一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。
- **分区容错性（Partition tolerance）**

  网络分区指分布式系统中的节点被划分为多个区域，每个区域内部可以通信，但是区域之间无法通信。

  `<u>`在分区容错性条件下，分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障。`</u>`

CAP 仅适用于原子读写的 NOSQL 场景中，并不适合数据库系统。现在的分布式系统具有更多特性比如扩展性、可用性等等，在进行系统设计和开发时，我们不应该仅仅局限在 CAP 问题上

**当发生网络分区的时候，如果我们要继续服务，那么一致性和可用性只能 2 选 1。也就是说当网络分区（其实就是分布式）之后 P 是前提，决定了 P 之后才有 C 和 A 的选择。也就是说对于分布式系统来说，分区容错性（Partition tolerance）我们是必须要实现的。**

举个简单的例子：来源 https://juejin.cn/post/6874599410802622472

有用户向 Node1 发送了请求更改了数据，将数据库从 V0 更新成了 V1。此时，节点之间网络断开，节点之间无法通信，所以 Node2 数据库依然是 V0，如果这个时候有一个请求发给了 Node2，但是 Node2 并没有办法可以直接给出最新的结果 V1，这个时候该怎么办呢？ 无非两种方法：

- 一种是将错就错，将错误的 V0 数据返回给用户
- 第二种是阻塞等待，等待网络通信恢复，Node2 中的数据更新之后再返回给用户

显然前者牺牲了一致性，后者牺牲了可用性。

### CP 与 AP 怎么选择？

> 参考 https://juejin.cn/post/7021717177220726798

CAP 不可同时满足，P 又一定要保证，那么我们是选择 CP 还是选择 AP 呢？

对于多数大型互联网应用的场景，主机众多、部署分散。而且现在的集群规模越来越大，所以节点故障、网络故障是常态。比如电商网站浏览数据，如果部分节点挂了，肯定不会说不让你浏览商品了，你会明显的感受到数据加载数据变慢了，但是最终数据还是能加载出来。（这就是保证了可用性）

那如果是涉及到金钱的系统，C（一致性） 是必须保证的。所以一般情况下金融系统都会选择后半夜发布，并且在发布的时候会增加提示语说系统升级，可能会导致部分功能不可用。这就是为了保证数据的一致性，牺牲了系统的可用性。

因此，CP 好还是 AP 好这个是没有一个绝对的结论的，需要根据实际的场景来决定使用哪个理论。

## BASE 理论

> 参考 https://juejin.cn/post/6874599410802622472#heading-16

BASE 是对CAP中一致性和可用性权衡的结果，BASE 理论的核心思想是就是：

- 即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。

  也就是**牺牲数据的一致性来满足系统的【高可用性】，系统中一部分数据不可用或者不一致时，仍需要保持系统整体 “主要可用” **。

**BASE** 是 **Basically Available（基本可用）** 、**Soft-state（软状态）** 和 **Eventually Consistent（最终一致性）** 三个短语的缩写。

<img src="https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/20201122170911.png" style="zoom:67%;" />

- **基本可用**

  `<u>`基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。但是，这绝不等价于系统不可用。`</u>`

  比如：

  - **响应时间上的损失**:正常情况下，一个在线搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障，查询结果的响应时间增加了 1~2 秒
  - **系统功能上的损失**：正常情况下，在一个电子商务网站上进行购物的时候，消费者几乎能够顺利完成每一笔订单，但是在一些节日大促购物高峰的时候，由于消费者的购物行为激增，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面

    ![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221008113342167.png)
- **软状态**

  相对于一致性，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。

  软状态指的是：允许系统中的数据 `存在中间状态`，并认为该状态 `不影响系统的整体可用性`，即允许系统在多个不同节点的数据副本之间进行数据同步的过程中存在延迟。
- **最终一致性**

  最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，`<u>`最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性`</u>`。

总的来说，BASE 理论面向的是大型高可用可扩展的分布式系统，和传统的事物ACID特性是相反的，**它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态**
