---
title: 第 5 章：计算高性能
date: 2022-10-22 15:53:54
permalink: /pages/192329/
---
高性能架构设计主要集中在两点：

1. 尽量提升单服务器的性能，将单服务器的性能发挥到极致
2. 如果单服务器无法支撑性能，设计服务器集群方案

## 单服务器高性能

单服务器高性能的关键之一就是服务器采取的网络编程模型，网络编程模型有如下两个关键设计点：

1. 服务器如何管理连接
2. 服务器如何处理请求

这俩设计点其实最终都和操作系统的 IO 模型和进程模型有关：

1. IO 模型：阻塞、非阻塞、同步、异步
2. 进程模型：单进程、多进程、多线程

### PPC, Process per Connection

每来一个新连接，就创建一个新进程去专门处理

![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022160004509.png)

适用于连接数不是很多的场景

缺点：

- fork 代价高
- 父子进程通信复杂（需要采用进程间通信的手段）
- 进程数量增大后多系统压力较大

### prefork

由于 fork 代价高，prefork 方案的思想就是提前创建进程，在系统启动的时候就预先创建好进程，然后才开始接受用户访问请求。

![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022160311646.png)

### TPC, Thread per Connection

对应 PPC 用进程来处理连接，TPC 就是采用线程来处理连接

![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022160403851.png)

TPC 创建线程的代价 < PPC 创建进程的代价，并且无需进程间通信

但引入了新的问题，多线程之间涉及到资源共享，可能导致死锁问题。

高并发情况，甚至可能 PPC 用的还多一点，因为不会有死锁问题，稳定性更高

### prethread

和 prefork 对应，prethread 方案的思想就是提前创建线程，在系统启动的时候就预先创建好线程，然后才开始接受用户访问请求。

![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022160629815.png)

### Reactor

非阻塞同步的网络模型，核心是 I/O 多路复用 + 线程池

- 单 Reactor 单线程
- 单 Reactor 多线程
- 多 Reactor 多线程

### Proactor

非阻塞异步，Linux 下的异步 IO（AIO）尚不完善，所以 Linux 下实现高并发，基本都是以 Reactor 模式为主

## 集群高性能

这里针对的是计算高性能，计算的特点就是无论哪台服务器，计算的结果都是一样的

所以集群计算高性能主要考虑的问题是**如何设计合理的任务分配策略（负载均衡）**。

### 负载均衡分类

常见的负载均衡系统有三类：

- **DNS 负载均衡**：一般用来实现地理级别的负载均衡，比如北方的用户访问北京的机房。本质是 DNS 解析一个域名可以返回多个不同的 IP 地址

  ![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022161514557.png)

- **硬件负载均衡**：通过单独的硬件设备完成负载均衡功能，跟交换机、路由器相似。目前典型的硬件负载均衡设备有 F5 和 A10 两款（价格都比较高昂）

- **软件负载均衡**：常见的有 Nginx（软件的七层负载均衡，支持 HTTP 和 Email 协议） 和 LVS（Linux 内核的四层负载均衡，和协议无关，几乎所有的应用都可以做）。软件负载均衡的性能 < 硬件负载均衡，成本当然也是比较小的

  ![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022161914476.png)

  Nginx 负载均衡架构示意图：

  ![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022161942790.png)

### 负载均衡架构

组合的基本原则是：

- DNS 负载均衡用于实现地理级别的负载均衡
- 硬件负载均衡用于实现集群级别的负载均衡
- 软件负载均衡用于实现机器级别的负载均衡

![](https://cs-wiki.oss-cn-shanghai.aliyuncs.com/img/image-20221022162152758.png)

### 负载均衡算法

- 轮询
- 加权轮询
- 负载最低优先
- 性能最优类（优先分配给处理速度最好的服务器）
- Hash 类（相同 Hash 分配到同一台服务器）